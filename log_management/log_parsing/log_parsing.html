<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>log parsing</title>
	<link rel="stylesheet" href="https://rawgit.com/hakimel/reveal.js/master/css/reveal.css">
	<link rel="stylesheet" href="https://rawgit.com/hakimel/reveal.js/master/css/theme/moon.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/styles/xt256.min.css">
</head>

	<body>

		<div class="reveal">

			<div class="slides">

				<section>
					<section>
					</section>

					<section>
						<h1>about @me</h1>
						<a href="https://www.linkedin.com/in/kokaipeter"><i class="fa fa-linkedin-square fa-3x" aria-hidden="true"></i></a>
						<a href="https://github.com/Kokan"><i class="fa fa-github fa-3x" aria-hidden="true"></i></a>
						<a href="mailto:kokaipeter@gmail.com"><i class="fa fa-at fa-3x" aria-hidden="true"></i></a>
						<a href="http://kokan.github.io"><i class="fa fa-book fa-3x" aria-hidden="true"></i></a>
						<a href="https://twitter.com/K0k4n"><i class="fa fa-twitter fa-3x" aria-hidden="true"></i></a>
					</section>
				</section>

				<section>
					<section>
						<h1>One Identity</h1>
					</section>
				</section>

				<section>
					<section>
						<h1>syslog-ng</h1>
						<a href="https://www.syslog-ng.com/">https://www.syslog-ng.com/</a>
					</section>
				</section>

				<section class="syslog-ng-trivia">

				<section>
					<h1>syslog-ng trivia</h1>
				</section>

				<section>
					<pre><code class="syslog-ng" data-trim data-noescape>
@version: 3.21
					</code></pre>
				</section>

				<section>
					<pre><code class="syslog-ng" data-trim data-noescape>
@version: 3.21

source name-of-my_source-group {
	file("/var/app/log.txt"); 
};
					</code></pre>
				</section>

				<section>
					<pre><code class="syslog-ng" data-trim data-noescape>
@version: 3.21

source name-of-my_source-group {
	file("/var/app/log.txt"); 
};

destination d0 {
     file("/important/logs/all_app_log.txt");
};
					</code></pre>
				</section>

				<section>
					<pre><code class="syslog-ng" data-trim data-noescape>@version: 3.21

source name-of-my_source-group {
	file("/var/app/log.txt"); 
};

destination d0 {
     file("/important/logs/all_app_log.txt");
};

log {
  source(name-of-my_source-group);
  destination(d0);
};
					</code></pre>

					<pre><code class="fragment" data-fragment-index="1" data-trim data-noescape>@version: 3.21

log {
  source { file("/var/app/log.txt"); };
  destination { file("/important/logs/all_app_log.txt"); };
};
					</code></pre>
				</section>

				</section>

				<section>
					<section>
						<h1>source</h1>
					</section>
					<section>
						<pre><code data-trim data-noescape>
<18>2019-04-17T07:40:54 hasthelargehadroncolliderdestroyedtheworldyet.com universe[1234]: NOPE.
						</code></pre>
						<pre><code data-trim data-noescape>
source s {
  network("127.0.0.1");
};
						</code></pre>
						<pre><code data-trim data-noescape>
PRIORITY=crit
HOST=hasthelargehadroncolliderdestroyedtheworldyet.com
MESSAGE=NOPE.
TIMESTAMP=Apr 17 07:40:54
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
<18>1 2019-04-17T07:58:28+02:00 hasthelargehadroncolliderdestroyedtheworldyet.com universe 1234 - - NOPE.
						</code></pre>
						<pre><code data-trim data-noescape>
source s {
  network("127.0.0.1" flags(syslog-protocol));
};
						</code></pre>
						<pre><code data-trim data-noescape>
PRIORITY=critical
HOST=127.0.0.1
MESSAGE=hi there
TIMESTAMP=now
						</code></pre>
					</section>

					<section>
						<h2>example flags</h2>
						<ul>
							<li>dont-store-legacy-msghdr</li>
							<li>empty-lines</li>
							<li>expect-hostname</li>
							<li>kernel</li>
							<li>no-hostname</li>
							<li>no-multi-line</li>
							<li>no-parse</li>
							<li>sanitize-utf8</li>
							<li>store-raw-message</li>
							<li>syslog-protocol</li>
						</ul>
					</section>

					<section>
						<pre><code data-trim data-noescape>
<18>1 2019-04-17T07:58:28+02:00 hasthelargehadroncolliderdestroyedtheworldyet.com universe 1234 - - NOPE.
						</code></pre>
						<pre><code data-trim data-noescape>
source s {
  network("127.0.0.1" flags(no-parse));
};
						</code></pre>
						<pre><code data-trim data-noescape>
MESSAGE=<18>1 2019-04-17T07:58:28+02:00 hasthelargehadroncolliderdestroyedtheworldyet.com universe 1234 - - NOPE.
						</code></pre>
					</section>
				</section>

				<section>
					<section>
						<h1>template, macro</h1>
					</section>
					<section>
						<pre><code data-trim data-noescape>
destination d0 {
  file("/dev/stdout");
};
						</code></pre>
						<pre><code data-trim data-noescape>
Apr 17 07:40:54 hasthelargehadroncolliderdestroyedtheworldyet.com universe[1234]: NOPE.
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
destination d0 {
  file("/dev/stdout" template("$MESSAGE\n"));
};
						</code></pre>
						<pre><code data-trim data-noescape>
NOPE.
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
destination d0 {
  file("/dev/stdout" template("command=${.unix.cmd} id=${.unix.uid}\n"));
};
						</code></pre>
						<pre><code data-trim data-noescape>
command=/usr/bin/nc id=1007
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
destination d0 {
  file("/dev/stdout" template("$(sha512 message}\n"));
};
						</code></pre>
						<pre><code data-trim data-noescape>
ffcb53bdcf177e601ecf72df1edf659b94b85b41e48d8133c527259b0567714ba8ae5dcb2ae99b6ec0bcf703a09017c91d64124c1e5ba0892e56db8ea5f6488d
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
rewrite credit-card-hide {
        subst("`credit-card-regexp`",
              "$(sha1 --length 16 $1)",
              value("MESSAGE"),
              flags(global, store-matches),
              type(pcre));
};

log { source(s); ... rewrite(credit-card-hide); ... destination(d0); };
						</code></pre>
						<pre><code data-trim data-noescape>
ffcb53bdcf177e601ecf72df1edf659b94b85b41e48d8133c527259b0567714ba8ae5dcb2ae99b6ec0bcf703a09017c91d64124c1e5ba0892e56db8ea5f6488d
						</code></pre>
					</section>

				</section>

				<section>
					<section>
						<h1>parser</h1>
					</section>
					<section>
						<pre><code data-trim data-noescape>
{"apple": "tree", "key": {"note": "chain"}}
						</code></pre>
						<pre><code data-trim data-noescape>
parser json {
  json-parser(prefix(".things."));
};
						</code></pre>
						<pre><code data-trim data-noescape>
log { source(s); parser(json); destination(d0); };
						</code></pre>
						<pre><code data-trim data-noescape>
.things.apple=tree .things.key.note=chain
						</code></pre>
					</section>
					<section>
						<pre><code data-trim data-noescape>
.things.apple=tree .things.key.note=chain
						</code></pre>
						<pre><code data-trim data-noescape>
parser kv {
  kv-parser(prefix(".again"));
};
						</code></pre>
						<pre><code data-trim data-noescape>
.again.things.apple=tree .again.things.key.note=chain
						</code></pre>
					</section>
					<section>
						<h3>additional parsers</h3>
						<ul>
							<li>add-contextual-data</li>
							<li>csv-parser</li>
							<li>date-parser</li>
							<li>db-parser</li>
							<li>geoip2</li>
							<li>geoip</li>
							<li>grouping-by</li>
							<li>json-parser</li>
							<li>kv-parser</li>
							<li>linux-audit-parser</li>
							<li>map-value-pairs</li>
							<li>python</li>
							<li>snmptrapd-parser</li>
							<li>syslog-parser</li>
							<li>tags-parser</li>
							<li>xml</li>
						</ul>
					</section>
				</section>

				<section>
					<section>
						<h1>some combination</h1>
					</section>
					<section>
						<h2>iptables</h2>
						<pre><code data-trim data-noescape>
April 19 11:20:13 localhost kernel: INPUT:DROP:IN=lo OUT= MAC=x SRC=127.0.0.1 DST=127.0.0.1 LEN=48 TOS=0x00
PREC=0x00 TTL=120 ID=x PROTO=TCP SPT=x DPT=x WINDOW=x RES=0x00 SYN URGP=0
						</code></pre>
						<pre><code data-trim data-noescape>
parser iptables {
  kv-parser(prefix(".iptables."));
};

						</code></pre>
					</section>
					<section>
						<h2>sudo</h2>
						<pre><code data-trim data-noescape>
Apr 17 14:12:30 localhost sudo[1]: peterkokai : 1 incorrect password attempt ; TTY=pts/3 ;
PWD=/home/user ; USER=root ; COMMAND=/usr/bin/ps
						</code></pre>
						<pre><code data-trim data-noescape>
parser sudo {
    kv-parser(prefix(".sudo.") pair-separator(';') extract-stray-words-into('0'));
    csv-parser(columns(".sudo.SUBJECT") template("$(list-head $0)") delimiters(' '));
};

						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
source s {
  network(... flags(no-parse));
};
parser syslog-p {
  syslog-parser();
};

log { source(s); parser(syslog-p); ... };

						</code></pre>
					</section>

					<section>
						<h2>iptables source</h2>
						<pre><code data-trim data-noescape>
April 19 11:20:13 localhost kernel: INPUT:DROP:IN=lo OUT= MAC=x SRC=127.0.0.1 DST=127.0.0.1 LEN=48 TOS=0x00
PREC=0x00 TTL=120 ID=x PROTO=TCP SPT=x DPT=x WINDOW=x RES=0x00 SYN URGP=0
						</code></pre>
						<pre><code data-trim data-noescape>
log {
source { network("127.0.1" port(1234));
parser iptables {
  kv-parser(prefix(".iptables."));
};
};

						</code></pre>
					</section>

					<section>
						<h2>iptables parser</h2>
						<pre><code data-trim data-noescape>
block parser iptables(prefix(".iptables"))
{
  kv-parser(prefix("`prefix`"));
};
						</code></pre>
					</section>

					<section>
						<h2>iptables source</h2>
						<pre><code data-trim data-noescape>
block source iptables(prefix(".iptables"))
{
  channel {
	parser { kv-parser(prefix("`prefix`")); };
  };
};
						</code></pre>
					</section>

					<section>
						<h2>iptables source</h2>
						<pre><code data-trim data-noescape>
block source iptables(prefix(".iptables"), flags(""), ip(), port())
{
  channel {
	source { network(ip("`ip`") port(`port`) flags(`flags`)); };
	parser { kv-parser(prefix("`prefix`")); };
  };
};
						</code></pre>
					</section>

				</section>

				<section>
					<section>
						<h1>branching</h1>
					</section>

					<section>
						<pre><code data-trim data-noescape>
if {
    filter { };
    parser { };
} elif {
    filter { };
    parser { };
} else {
    filter { };
};

						</code></pre>
					</section>

					<section>
						<pre><code class="fragment" data-fragment-index="1" data-trim data-noescape> block parser cisco-timestamp-parser(template()) {
    channel {
        rewrite {
            set("`template`" value('1'));
        };
						</code></pre>
						<pre><code class="fragment" data-fragment-index="2" ata-trim data-noescape> if {
            # timestamp from Cisco Unified Call Manager, example "Jun 14 11:57:27 PM.685 UTC"
            # NOTE: drops msecs and timezone
            filter { match('^[.*]?([A-Za-z]{3} [0-9 ]\d \d{2}:\d{2}:\d{2} ((AM)|(PM)))' value('1') flags(store-matches)); };
            parser { date-parser(format('%b %d %H:%M:%S %p') template("$1")); };
        } elif {
						</code></pre>
						<pre><code class="fragment" data-fragment-index="3" data-trim data-noescape> } elif {
            # timestamp without AM/PM mark, example: "Apr 29 13:58:40.411"
            # NOTE: drops msecs and timezone

            filter { match('^[.*]?([A-Za-z]{3} [0-9 ]\d \d{2}:\d{2}:\d{2})' value('1') flags(store-matches)); };
            parser { date-parser(format('%b %d %H:%M:%S') template("$1")); };
        } else {
						</code></pre>
						<pre><code class="fragment" data-fragment-index="4" data-trim data-noescape> } else {
            # timestamp with year information, example: "Apr 29 2017 13:58:40.411"
            filter { match('^[.*]?([A-Za-z]{3} [0-9 ]\d \d{4} \d{2}:\d{2}:\d{2})' value('1') flags(store-matches)); };
            parser { date-parser(format('%b %d %Y %H:%M:%S') template("$1")); };
        };
    };
};
						</code></pre>
					</section>
				</section>

				<section>
					<section>
						<h1>app-parser</h1>
					</section>

					<section>
						<pre><code data-trim data-noescape>
parser { app-parser(topic(custom-name)); };
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
application my_app_parser_name[custom-name]
{
   parser { xml-parser(); };
};
						</code></pre>
					</section>

					<section>
						<pre><code data-trim data-noescape>
application iptables[syslog] {
        filter { facility(kern) and
                 program("kernel" type(string)) and
                 message("PROTO=" type(string) flags(substring)); };
        parser { iptables-parser(); };
};

						</code></pre>
					</section>
				</section>

                                <section>
                                        <i class="fa fa-question fa-5x" aria-hidden="true"></i>
                                        <i class="fa fa-lightbulb-o fa-5x" aria-hidden="true"></i>
                                </section>

			</div>

		</div>

		<script src="https://use.fontawesome.com/19010dbc51.js"></script>

		<script type="text/javascript" src="https://rawgit.com/hakimel/reveal.js/master/js/reveal.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.9.0/highlight.min.js"></script>

		<script>
			Reveal.initialize({
				width: '100%',
				height: '100%'
			});
			hljs.initHighlightingOnLoad();
		</script>

</body>
</html>
